name: Node.js CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Pull latest code (instead of clone)
      run: |
        cd /home/ubuntu/BackendForCICD/BackendForCICD/BackendForCICD
        if [ ! -d ".git" ]; then
          echo "Cloning repo for the first time..."
          git clone https://github.com/${{ github.repository }} .
        else
          echo "Pulling latest changes..."
          git reset --hard
          git clean -fd
          git pull origin main
        fi

    - name: Install dependencies if needed
      run: |
        cd /home/ubuntu/BackendForCICD/BackendForCICD/BackendForCICD
        if [ ! -d "node_modules" ] || git diff --name-only HEAD HEAD~1 | grep -qE "package(-lock)?\.json"; then
          echo "Installing dependencies..."
          npm ci
        else
          echo "Skipping npm ci (no changes in dependencies)"
        fi

    - name: Restore .env
      run: |
        cd /home/ubuntu/BackendForCICD/BackendForCICD/BackendForCICD
        touch .env
        echo "${{ secrets.PROD_ENV_FILE }}" > .env

    - name: Restart PM2
      run: |
        cd /home/ubuntu/BackendForCICD/BackendForCICD/BackendForCICD
        pm2 delete bckCICD || true
        pm2 start npm --name "bckCICD" -- start
        pm2 save
